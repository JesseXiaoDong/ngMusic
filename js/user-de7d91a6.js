var mainModule,SEARCHURL,SERVERURL,LOGINURL,musicApp=angular.module("MusicApp",["ui.router","MainModule"]);musicApp.config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/index"),a.state("index",{url:"/index",views:{"":{templateUrl:"tpls/main.html"},"choose@index":{templateUrl:"tpls/choose.html"},"list@index":{templateUrl:"tpls/list.html"},"music@index":{templateUrl:"tpls/musicctrl.html"}}}).state("login",{url:"/login",views:{"":{templateUrl:"tpls/login.html"}}})}]),mainModule=angular.module("MainModule",[]),SEARCHURL="http://cors.coding.io",SERVERURL="http://ngmusic.coding.io/node",LOGINURL="http://iuser.coding.io/auth",mainModule.directive("loadchannel",["$rootScope","MusicService","MessageService",function(a,b,c){return{restrict:"AE",link:function(d,e){e.on("click",function(d){d.stopPropagation();var f=e.attr("data-id");a.name="随心听: "+e.attr("data-name"),a.$apply(),b.updateList(f),c.channelChange(),c.loadingBroadcast(!0,"加载中...")})}}}]),mainModule.directive("pauseaudio",["MusicService",function(a){return{restrict:"A",link:function(b,c){c.on("click",function(b){b.stopPropagation(),a.playorpauseSong()})}}}]),mainModule.directive("removespan",["MusicService","MessageService",function(a){return{restrict:"A",link:function(b,c){c.on("click",function(b){b.stopPropagation();var d=c.parent().attr("data-index"),e=a.getSetting("isUsrPlay");e?a.removeSong(d):a.addOneSong(d,!0)})}}}]),mainModule.directive("playaudio",["MusicService",function(a){return{restrict:"AE",link:function(b,c){c.on("click",function(b){b.stopPropagation();var d=c.attr("data-index");a.getSetting("searchMode")?(a.addOneSong(d),a.changePlayer(0)):a.playSong(d)})}}}]),mainModule.directive("detectiveenter",["MusicService",function(a){return{restrict:"AE",link:function(b,c){c.on("keydown",function(b){13===b.keyCode&&a.changePlayer(2,c[0].value)})}}}]),mainModule.directive("progressdiv",["MusicService",function(a){return{restrict:"AE",link:function(b,c){function d(b){if(e){var d=c[0].getBoundingClientRect(),h=g.getBoundingClientRect().width,i=b.x-d.left;i>h?i=h:i>d.width&&(i=d.width),f.style.width=i+"px",a.setAudiocurrentTime(i/d.width)}return b.stopPropagation(),b.preventDefault(),!1}var e=!1,f=document.getElementById("currentprogress"),g=document.getElementById("loadedprogress");c.on("mousedown",function(){e=!0,document.addEventListener("mousemove",d)}),document.addEventListener("mouseup",function(a){d(a),e=!1,document.removeEventListener("mousemove",d)})}}}]),mainModule.service("MusicService",["$http","$q","$rootScope","MessageService",function(a,b,c,d){function e(a,b){for(var c in a)b.hasOwnProperty(c)&&(a[c]=b[c])}function f(){var b,a={};for(b in D)D.hasOwnProperty(b)&&"audioList"!=b&&"channelList"!=b&&(a[b]=D[b]);setTimeout(function(){localStorage.setItem("shang_music",JSON.stringify({setting:a,userSongIds:B}))})}function g(){var c=b.defer();return d.loadingBroadcast(!0,"获取中~~",1e3),a({url:SERVERURL+"/usersongs",method:"GET",headers:{"x-access-token":localStorage.getItem("token")},withCredentials:!0}).success(function(a){d.loadingBroadcast(!1),-1===a.errCode?c.reject("请重新登录~"):(B=JSON.parse(a.data)||B,c.resolve(B))}).error(function(){c.reject("请重新登录~")}),c.promise}function h(b){a.put(SERVERURL+"/usersongs",{songs:JSON.stringify(B)},{headers:{"x-access-token":localStorage.getItem("token")},withCredentials:!0}).success(function(a){0!==a.errCode?location.href="/#/login":b&&d.toastBroadcast(!0,"上传成功!",3e3)}).error(function(){location.href="/#/login"})}function i(){H?(H.style.width=u()*K+"px",J.style.width=z.currentTime/z.duration*K+"px"):(H=document.getElementById("loadedprogress"),I=document.getElementById("progressbar"),J=document.getElementById("currentprogress"),K=I.getBoundingClientRect().width||0)}function j(){k((D.currentIndex+1)%D.audioList.length)}function k(a){v(),(a||0===a)&&(D.currentIndex=parseInt(a)),-1===D.currentIndex||D.currentIndex>=D.audioList.length||(h(),l(),f())}function l(){z.src=D.audioList[D.currentIndex].songLink,z.play(),D.isplaying=!0,c.alltime=m(D.audioList[D.currentIndex].time),c.$broadcast("current.update"),c.currentIndex=D.currentIndex,d.toastBroadcast(!0,D.audioList[D.currentIndex].songName,2e3),A=shangLrcLoad.getInstance(z,"lrcdiv"),a.get(SEARCHURL+"?method=get&callback=obj&url=http://music.baidu.com"+D.audioList[D.currentIndex].lrcLink).success(function(a){A.loadNewLrc(a.data,0)}).error(function(){A.loadNewLrc("[00:00]未找到(┬＿┬)",0)})}function m(a){a=a||z.currentTime;var b=Math.floor(a/60),c=Math.round(a%60)<10?"0"+Math.round(a%60):Math.round(a%60);return b+":"+c}function n(a){A&&z&&(A.setRepaireTimeNu(parseInt(A.getRepaireTimeNu())+parseInt(a)),d.toastBroadcast(!0,A.getRepaireTimeNu()/10+"",3e3))}function o(a,b){if(!a||!a.data||!a.data.songList)return void(D.audioList=[]);var c=a.data.songList,d=c.filter(function(a){return a.songLink&&/file\.qianqian\.com/.test(a.songLink)&&!/serverget\?url/.test(a.songLink)?a.songLink="http://cors4ngmusic.coding.io/?fun=fun&url="+encodeURIComponent(a.songLink):a.songLink&&(a.songLink=a.songLink.replace("http://yinyueshiting.baidu.com/data2/music/","http://musicdata.baidu.com/data2/music/")),a.rate});D.audioList=d,b&&(C=d)}function p(c){if(c&&(c=c.trim())){var d=b.defer();return a.get(SEARCHURL+"?method=get&url="+encodeURIComponent("http://sug.music.baidu.com/info/suggestion?format=json&word="+c+"&version=2&from=0")).success(function(a){d.resolve(a)}).error(function(){d.resolve("")}),d.promise}}function q(){var c=b.defer();return a.get("getchannellist").success(function(a){c.resolve(a.channel_list)}).error(function(a){c.reject(a)}),c.promise}function r(c){var d=b.defer();return a.get("getsonglink?id="+c).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise}function s(a){var b=r(a);b.then(function(a){o(a),c.$broadcast("aduioList.update")},function(){D.audioList=[],c.$broadcast("aduioList.update")})}function t(){var a=q();a.then(function(a){D.channelList=a;var b=Math.floor(Math.random()*a.length);s(b),d.channelChange(),d.loadingBroadcast(!0,a[b].channel_name),c.name=a[b].channel_name},function(){})}function u(){var a,b;return z?(a=z.buffered,a.length?(b=a.end(a.length-1),b/z.duration):void 0):0}function v(){H&&J&&(H.style.width="0px",J.style.width="0px")}function w(a){var b=parseInt(a);return 1===D.audioList.length||-1>=b?(D.audioList=[],B=[],D.currentIndex=-1,c.$broadcast("clear"),void f()):(b===D.currentIndex&&j(),D.audioList.splice(b,1),B.splice(b,1),b<=D.currentIndex&&(D.currentIndex-=1),c.currentIndex=D.currentIndex,c.$broadcast("searchback.update"),void f())}var x,F,H,I,J,K,y=null,z=new Audio,A=null,B=[5963228],C=[],D={currentHadPlayedNu:0,audioList:[],currentIndex:-1,playMode:0,isUsrPlay:!0,isplaying:!1,channelList:[],searchMode:!1},E=localStorage.getItem("shang_music");if(E)try{F=JSON.parse(E),x=F.setting||{},B=F.userSongIds||[]}catch(G){x={},B=[]}finally{e(D,x)}return z.onerror=function(){/\/null$/.test(z.src)||(D.currentHadPlayedNu<=2?setTimeout(function(){z.src=D.audioList[D.currentIndex].songLink,z.play(),D.currentHadPlayedNu++},500):(clearTimeout(y),y=setTimeout(function(){D.currentHadPlayedNu=0,d.toastBroadcast(!0,"加载失败,播放下一首(┬＿┬)",1e3),j()},1e3)))},z.ontimeupdate=function(){c.time=m(),c.$apply(),i()},z.onended=function(){if(1===D.playMode)k(D.currentIndex);else if(0===D.playMode)j();else{var a=D.audioList.length;k(Math.floor(Math.random()*a))}},H=document.getElementById("loadedprogress"),I=document.getElementById("progressbar"),J=document.getElementById("currentprogress"),K=0,c.$on("clear",function(){A=shangLrcLoad(z,"lrcdiv"),A.parseLrc(""),A.setRepaireTimeNu(0),A.init(),z.src=null,z.load()}),{channelList:q,songlink:r,getSongInfo:function(c){var d=b.defer();return a.get("getsonginfo?id="+c).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},updateList:s,getAudioList:function(){return D.audioList},playSong:k,playorpauseSong:function(a){a?(z.pause(),D.isplaying=!1):(z.play(),D.isplaying=!0)},playNextSong:j,playPrevSong:function(){this.playSong((D.currentIndex-1+D.audioList.length)%D.audioList.length)},getCurrentSong:function(){return D.audioList[D.currentIndex]},changePlayer:function(b,e){var f,g,h,i,j;if(d.loadingBroadcast(!0,"加载中"),D.searchMode=!1,D.isUsrPlay=0===b,0===b){for(f=!0,g=C.slice(0).sort(function(a,b){return a.songId-b.songId}),h=B.slice(0).sort(function(a,b){return a-b}),i=0;i<h.length;i++)g[i]&&h[i]===g[i].songId||(f=!1);if(f)return D.isUsrPlay=!0,D.audioList=C,c.$broadcast("mode.update"),void d.loadingBroadcast();d.loadingBroadcast(!0,"自定义播放列表"),a.get("getsongsbyids?data="+encodeURIComponent(JSON.stringify({ids:B}))).success(function(a){o(a,!0),D.isUsrPlay=!0,c.$broadcast("mode.update"),d.loadingBroadcast()}).error(function(){d.loadingBroadcast()})}else if(1===b)d.loadingBroadcast(),t();else if(2===b){if(D.searchMode=!0,d.loadingBroadcast(!0,"搜索"+e+"中..."),j=p(e),!j)return d.toastBroadcast(!0,"请输入内容",3e3),void d.loadingBroadcast();j.then(function(b){D.isUsrPlay=!1;var e=b.data.song;e=e.map(function(a){return a.songid}),a.get("getsongsbyids?data="+encodeURIComponent(JSON.stringify({ids:e}))).success(function(a){o(a),c.$broadcast("search.update"),d.loadingBroadcast()}).error(function(){d.loadingBroadcast()})})}else 3===b&&(d.loadingBroadcast(),D.audioList=C,D.isUsrPlay=!0,c.$broadcast("searchback.update"))},searchSong:p,addOneSong:function(a,b){for(var c=D.audioList[a],e=-1,g=0;g<C.length;g++)if(C[g].songId===c.songId){e=g;break}-1===e?(B.push(c.songId),C.push(c),D.currentIndex=C.length-1,d.toastBroadcast(!0,"添加成功~",3e3)):(b&&(D.currentIndex=e),d.toastBroadcast(!0,"已经存在~",3e3)),b||(D.audioList=C),f()},removeSong:w,getSetting:function(a){return D.hasOwnProperty(a)?D[a]:""},setSetting:function(a,b){D.hasOwnProperty(a)&&(D[a]=b)},setAudiocurrentTime:function(a){try{z.currentTime=a*z.duration}catch(b){z.setAudiocurrentTime&&z.setAudiocurrentTime(a-10>0?a-10:0)}},clearProgress:v,changeLrcTime:n,getSongs:g,upload:h}}]),mainModule.service("MessageService",["$rootScope",function(a){var b=null,c=!1,d="",e=!1,f="";return{loadingBroadcast:function(a,b){this.setLoading(a||!1),this.setLoadingMsg(b||""),this.broadcast()},setLoading:function(a){c=a},getLoading:function(){return c},setLoadingMsg:function(a){d=a},getLoadingMsg:function(){return d},toastBroadcast:function(a,c,d){if(this.settoast(a||!1),this.settoastMsg(c||""),this.broadcast(),parseInt(d)){var e=this;clearTimeout(b),b=setTimeout(function(){e.toastBroadcast(!1)},parseInt(d))}},settoast:function(a){e=a},gettoast:function(){return e},settoastMsg:function(a){f=a},gettoastMsg:function(){return f},broadcast:function(){a.$broadcast("message.update")},channelChange:function(){a.$broadcast("channel.toggle")}}}]),mainModule.controller("channelCtrl",["$rootScope","$scope","MusicService","MessageService",function(a,b,c,d){function e(){b.channels=c.getSetting("channelList"),b.showhide=f?"eleDownIn":"eleDownOut",f=!f}b.isLoading=!0,b.isUsrPlay=c.getSetting("isUsrPlay"),b.toggleChannel=e,b.$on("channel.toggle",e);var f=!1;b.togglePlayer=function(){var a=c.getSetting("isUsrPlay");b.isUsrPlay=!a,f=!1,b.showhide="eleDownOut",a?(d.loadingBroadcast(!0,"切换到随心听..."),c.changePlayer(1)):(d.loadingBroadcast(!0,"切换到用户列表..."),c.changePlayer(0))},b.upload=function(){c.upload(!0)}}]),mainModule.controller("listCtrl",["$rootScope","$scope","$state","MusicService","MessageService",function(a,b,c,d,e){function f(){localStorage.removeItem("token"),c.go("login")}function g(a){b.songs=d.getAudioList(),e.loadingBroadcast(),d.playSong(a),b.songs.length&&e.toastBroadcast(!0,b.songs[a].songName,2e3)}if(!localStorage.getItem("token"))return c.go("login"),void e.toastBroadcast(!0,"请重新登录~",3e3);b.songs=[],b.search={},a.$on("clear",function(){b.songs=[],b.$apply()}),a.$on("aduioList.update",function(){b.isUsrPlay=!1,b.isadd=!0,g(0)}),a.$on("mode.update",function(){var e,c=d.getSetting("isUsrPlay");a.name=c?"播放列表":"随心听",b.isUsrPlay=c,b.issearch=!1,b.isadd=!c,e=d.getSetting("currentIndex"),(e>d.getAudioList().length||-1>=e)&&(e=0),g(e)}),a.$on("searchback.update",function(){var c=d.getSetting("isUsrPlay");a.name=c?"播放列表":"随心听",b.isUsrPlay=c,b.issearch=!1,b.isadd=!1,b.songs=d.getAudioList()}),a.$on("search.update",function(){b.isUsrPlay=!1,b.issearch=!0,a.name="搜索 "+b.search.name+" 的结果",b.songs=d.getAudioList()}),b.backUsr=function(){d.changePlayer(3)},b.searchSong=function(){d.changePlayer(2,b.search.name)},b.isUsrPlay=d.getSetting("isUsrPlay");var h=navigator.userAgent;return/AppleWebKit\/(\S+)/.test(h)?void d.getSongs().then(function(){d.changePlayer(b.isUsrPlay?0:1)})["catch"](function(){e.toastBroadcast(!0,"请重新登录~~",3e3),f()}):void(a.name="本网页只支持chrome内核浏览器\n\r原因:在不使用flash下\r\n只有chrome支持播放mp3")}]),mainModule.controller("musciCtrl",["$rootScope","$scope","MusicService",function(a,b,c){b.song={songPicRadio:"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"},b.playMode=c.getSetting("playMode"),b.isPlaying=c.getSetting("isplaying"),b.changePlaying=function(){c.playorpauseSong(b.isPlaying),b.isPlaying=c.getSetting("isplaying")},a.$on("current.update",function(){var d,e;a.time=null,d=c.getCurrentSong(),b.isPlaying=c.getSetting("isplaying"),b.song=d,d.songPicRadio="http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png",e=c.getSongInfo(d.songId),e.then(function(a){var d,e,c=a.data.songList;c&&c.length&&(d=c[0],e=d.songPicRadio,d.songPicRadio=e?/http:\/\/qukufile2\.qianqian\.com/.test(e)?e.match(/http:\/\/qukufile2\.qianqian\.com.*?jpg/)[0]:"serverget?url="+encodeURIComponent(d.songPicRadio):"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png",b.song.songPicRadio=d.songPicRadio)},function(){b.song.songPicRadio="http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"})}),a.$on("clear",function(){a.time=null,a.alltime=null,b.song={songPicRadio:"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"},b.playMode=c.getSetting("playMode"),b.isPlaying=!1,a.$apply(),b.$apply(),c.clearProgress(),c.setSetting("isplaying",!1)}),b.prev=function(){c.playPrevSong()},b.next=function(){c.playNextSong()},b.changeLoop=function(){c.setSetting("playMode",(parseInt(b.playMode)+1)%3),b.playMode=c.getSetting("playMode")},b.changeLrc=function(a){c.changeLrcTime(a)}}]),mainModule.controller("messageCtrl",["$rootScope","$scope","MessageService",function(a,b,c){b.$on("message.update",function(){b.isLoading=c.getLoading(),b.loadingMsg=c.getLoadingMsg(),b.isToast=c.gettoast(),b.toastMsg=c.gettoastMsg()})}]),mainModule.controller("loginCtrl",["$scope","$http","$state","MessageService",function(a,b,c,d){function e(){d.loadingBroadcast(!0,"登陆中"),b({url:LOGINURL,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:"username="+a.username+"&password="+a.password}).success(function(a){d.loadingBroadcast(!1),-1===a.errCode?d.toastBroadcast(!0,a.data||"登录失败~~",3e3):(localStorage.setItem("token",a.data.token),c.go("index"))}).error(function(){d.loadingBroadcast(!1),d.toastBroadcast(!0,"登录失败,请检查网络~~",3e3)})}localStorage.getItem("token")&&c.go("index"),a.login=e,a.username="shang"}]),shangLrcLoad=function(){function a(a,b){function c(a,b){n.push({time:a,lrcstr:b})}function d(){a.currentTime>=m-o/10&&(e(),d())}function e(){var a,b,c;l++,"undefined"!=typeof n[l]&&(clearInterval(q),m=n[l].time,p[l-2].className="",p[l-1].className="current",a=p[l-1].moveHeight-p[0].moveHeight-s,a=a>0?parseInt(a):0,b=r,c=b.scrollTop,q=setInterval(function(){var f,d=-8,e=(a-c)/-d;e=e>0?Math.ceil(e):Math.floor(e),f=c+e,b.scrollTop=f,a===f&&clearInterval(q),c=f},30))}function f(){var a,b,d;for(c(0,""),c(0,""),c(999999,""),n.sort(function(a,b){return a.time-b.time}),a=document.createElement("div"),r.appendChild(a),b=0;b<n.length;b++)d=document.createElement("p"),p.push(d),d.innerHTML=n[b].lrcstr,a.appendChild(d),d.moveHeight=d.offsetTop}function g(a){var b,d,e,f,g;if(a)for(b=a.split("\n"),d=0;d<b.length;d++)for(e=b[d].split("]"),f=0;f<e.length-1;f++)g=e[f].match(/(\d+)\:(\d+)((\.|\:)(\d+))?/),g&&!/^\s*$/.test(e[e.length-1])&&c(60*(+g[1]||0)+(+g[2]||0)+(+g[4]||0)/100,e[e.length-1])}function h(){for(var a=0;a<p.length;a++)p[a].className=""}function i(a){o=a}function j(){return o}function k(a,b){r.innerHTML="",l=1,m=-1,n=[],p=[],g(a),f(),i(b||0)}var l,m,n,o,p,q,r,s,t;return a="string"==typeof a?document.getElementById(a):a,b="string"==typeof b?document.getElementById(b):b,l=1,m=-1,n=[],o=0,p=[],q=null,r=document.createElement("div"),s=b.getBoundingClientRect().height/2-50,a.addEventListener("seeked",function(){l=1,m=-1}),a.addEventListener("timeupdate",function(){d()}),r.id="shang_lrc_div",b.appendChild(r),t=document.createElement("style"),t.type="text/css",t.innerHTML="#shang_lrc_div{margin:0;padding:0;overflow-y:scroll;overflow-x:hidden;height:100%}#shang_lrc_div::-webkit-scrollbar{width:5px;height:5px;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-button{display:none}#shang_lrc_div::-webkit-scrollbar-thumb{background:#ccc;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-corner{display:none}.current{color:blueviolet;font-weight:bold}",document.getElementsByTagName("head")[0].appendChild(t),{init:f,parseLrc:g,clearClass:h,setRepaireTimeNu:i,getRepaireTimeNu:j,loadNewLrc:k}}var b=null;return{getInstance:function(c,d){return b||(b=a(c,d)),b}}}();