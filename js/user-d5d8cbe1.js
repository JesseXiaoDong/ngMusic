var musicApp=angular.module("MusicApp",["ui.router","MainModule"]);musicApp.config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/index"),e.state("index",{url:"/index",views:{"":{templateUrl:"tpls/main.html"},"choose@index":{templateUrl:"tpls/choose.html"},"list@index":{templateUrl:"tpls/list.html"},"music@index":{templateUrl:"tpls/musicctrl.html"}}}).state("login",{url:"/login",views:{"":{templateUrl:"tpls/login.html"}}})}]);var mainModule=angular.module("MainModule",[]),SEARCHURL="http://cors.coding.io",SERVERURL="http://ngmusic.coding.io/node",LOGINURL="http://iuser.coding.io";mainModule.directive("loadchannel",["$rootScope","MusicService","MessageService",function(e,t,n){return{restrict:"AE",link:function(o,a){a.on("click",function(o){o.stopPropagation();var i=a.attr("data-id");e.name="随心听: "+a.attr("data-name"),e.$apply(),t.updateList(i),n.channelChange(),n.loadingBroadcast(!0,"加载中...")})}}}]),mainModule.directive("pauseaudio",["MusicService",function(e){return{restrict:"A",link:function(t,n){n.on("click",function(t){t.stopPropagation(),e.playorpauseSong()})}}}]),mainModule.directive("removespan",["MusicService","MessageService",function(e){return{restrict:"A",link:function(t,n){n.on("click",function(t){t.stopPropagation();var o=n.parent().attr("data-index"),a=e.getSetting("isUsrPlay");a?e.removeSong(o):e.addOneSong(o,!0)})}}}]),mainModule.directive("playaudio",["MusicService",function(e){return{restrict:"AE",link:function(t,n){n.on("click",function(t){t.stopPropagation();var o=n.attr("data-index");e.getSetting("searchMode")?(e.addOneSong(o),e.changePlayer(0)):e.playSong(o)})}}}]),mainModule.directive("detectiveenter",["MusicService",function(e){return{restrict:"AE",link:function(t,n){n.on("keydown",function(t){13===t.keyCode&&e.changePlayer(2,n[0].value)})}}}]),mainModule.directive("progressdiv",["MusicService",function(e){return{restrict:"AE",link:function(t,n){function o(t){if(a){var o=n[0].getBoundingClientRect(),s=r.getBoundingClientRect().width,c=t.x-o.left;c>s?c=s:c>o.width&&(c=o.width),i.style.width=c+"px",e.setAudiocurrentTime(c/o.width)}return t.stopPropagation(),t.preventDefault(),!1}var a=!1,i=document.getElementById("currentprogress"),r=document.getElementById("loadedprogress");n.on("mousedown",function(){a=!0,document.addEventListener("mousemove",o)}),document.addEventListener("mouseup",function(e){o(e),a=!1,document.removeEventListener("mousemove",o)})}}}]),mainModule.service("MusicService",["$http","$q","$rootScope","MessageService",function(e,t,n,o){function a(e,t){for(var n in e)t.hasOwnProperty(n)&&(e[n]=t[n])}function i(){var e={};for(var t in w)w.hasOwnProperty(t)&&"audioList"!=t&&"channelList"!=t&&(e[t]=w[t]);setTimeout(function(){localStorage.setItem("shang_music",JSON.stringify({setting:e,userSongIds:B}))})}function r(){var n=t.defer();return o.loadingBroadcast(!0,"获取中~~",1e3),e({url:SERVERURL+"/usersongs",method:"GET",headers:{"x-access-token":localStorage.getItem("token")},withCredentials:!0}).success(function(e){o.loadingBroadcast(!1),-1===e.errCode?n.reject("请重新登录~"):(B=JSON.parse(e.data)||B,n.resolve(B))}).error(function(){n.reject("请重新登录~")}),n.promise}function s(t){e.put(SERVERURL+"/usersongs",{songs:JSON.stringify(B)},{headers:{"x-access-token":localStorage.getItem("token")},withCredentials:!0}).success(function(e){0!==e.errCode?location.href="/#/login":t&&o.toastBroadcast(!0,"上传成功!",3e3)}).error(function(){location.href="/#/login"})}function c(){C?(C.style.width=S()*A+"px",N.style.width=x.currentTime/x.duration*A+"px"):(C=document.getElementById("loadedprogress"),T=document.getElementById("progressbar"),N=document.getElementById("currentprogress"),A=T.getBoundingClientRect().width||0)}function d(){u((w.currentIndex+1)%w.audioList.length)}function u(e){I(),(e||0===e)&&(w.currentIndex=parseInt(e)),-1===w.currentIndex||w.currentIndex>=w.audioList.length||(s(),l(),i())}function l(){x.src=w.audioList[w.currentIndex].songLink,x.play(),w.isplaying=!0,n.alltime=g(w.audioList[w.currentIndex].time),n.$broadcast("current.update"),n.currentIndex=w.currentIndex,o.toastBroadcast(!0,w.audioList[w.currentIndex].songName,2e3),b=shangLrcLoad.getInstance(x,"lrcdiv"),e.get(SEARCHURL+"?method=get&callback=obj&url=http://music.baidu.com"+w.audioList[w.currentIndex].lrcLink).success(function(e){b.loadNewLrc(e.data,0)}).error(function(){b.loadNewLrc("[00:00]未找到(┬＿┬)",0)})}function g(e){e=e||x.currentTime;var t=Math.floor(e/60),n=Math.round(e%60)<10?"0"+Math.round(e%60):Math.round(e%60);return t+":"+n}function p(e){b&&x&&(b.setRepaireTimeNu(parseInt(b.getRepaireTimeNu())+parseInt(e)),o.toastBroadcast(!0,b.getRepaireTimeNu()/10+"",3e3))}function f(e,t){if(!e||!e.data||!e.data.songList)return void(w.audioList=[]);var n=e.data.songList,o=n.filter(function(e){return e.songLink&&/file\.qianqian\.com/.test(e.songLink)&&!/serverget\?url/.test(e.songLink)?e.songLink="http://cors4ngmusic.coding.io/?fun=fun&url="+encodeURIComponent(e.songLink):e.songLink&&(e.songLink=e.songLink.replace("http://yinyueshiting.baidu.com/data2/music/","http://musicdata.baidu.com/data2/music/")),e.rate});w.audioList=o,t&&(k=o)}function m(n){if(n&&(n=n.trim())){var o=t.defer();return e.get(SEARCHURL+"?method=get&url="+encodeURIComponent("http://sug.music.baidu.com/info/suggestion?format=json&word="+n+"&version=2&from=0")).success(function(e){o.resolve(e)}).error(function(e){o.resolve("")}),o.promise}}function h(){var n=t.defer();return e.get(SERVERURL+"/getchannellist").success(function(e){n.resolve(e.channel_list)}).error(function(e){n.reject(e)}),n.promise}function v(n){var o=t.defer();return e.get(SERVERURL+"/getsonglink?id="+n).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise}function y(e){var t=v(e);t.then(function(e){f(e),n.$broadcast("aduioList.update")},function(e){w.audioList=[],n.$broadcast("aduioList.update")})}function L(){var e=h();e.then(function(e){w.channelList=e;var t=Math.floor(Math.random()*e.length);y(t),o.channelChange(),o.loadingBroadcast(!0,e[t].channel_name),n.name=e[t].channel_name},function(e){})}function S(){if(!x)return 0;var e=x.buffered;if(e.length){var t=e.end(e.length-1);return t/x.duration}}function I(){C&&N&&(C.style.width="0px",N.style.width="0px")}function M(e){var t=parseInt(e);return 1===w.audioList.length||-1>=t?(w.audioList=[],B=[],w.currentIndex=-1,n.$broadcast("clear"),void i()):(t===w.currentIndex&&d(),w.audioList.splice(t,1),B.splice(t,1),t<=w.currentIndex&&(w.currentIndex-=1),n.currentIndex=w.currentIndex,n.$broadcast("searchback.update"),void i())}var P,R=null,x=new Audio,b=null,B=[5963228],k=[],w={currentHadPlayedNu:0,audioList:[],currentIndex:-1,playMode:0,isUsrPlay:!0,isplaying:!1,channelList:[],searchMode:!1},$=localStorage.getItem("shang_music");if($)try{var E=JSON.parse($);P=E.setting||{},B=E.userSongIds||[]}catch(U){P={},B=[]}finally{a(w,P)}x.onerror=function(){/\/null$/.test(x.src)||(w.currentHadPlayedNu<=2?setTimeout(function(){x.src=w.audioList[w.currentIndex].songLink,x.play(),w.currentHadPlayedNu++},500):(clearTimeout(R),R=setTimeout(function(){w.currentHadPlayedNu=0,o.toastBroadcast(!0,"加载失败,播放下一首(┬＿┬)",1e3),d()},1e3)))},x.ontimeupdate=function(){n.time=g(),n.$apply(),c()},x.onended=function(){if(1===w.playMode)u(w.currentIndex);else if(0===w.playMode)d();else{var e=w.audioList.length;u(Math.floor(Math.random()*e))}};var C=document.getElementById("loadedprogress"),T=document.getElementById("progressbar"),N=document.getElementById("currentprogress"),A=0;return n.$on("clear",function(){b=shangLrcLoad(x,"lrcdiv"),b.parseLrc(""),b.setRepaireTimeNu(0),b.init(),x.src=null,x.load()}),{channelList:h,songlink:v,getSongInfo:function(n){var o=t.defer();return e.get(SERVERURL+"/getsonginfo?id="+n).success(function(e){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},updateList:y,getAudioList:function(){return w.audioList},playSong:u,playorpauseSong:function(e){e?(x.pause(),w.isplaying=!1):(x.play(),w.isplaying=!0)},playNextSong:d,playPrevSong:function(){this.playSong((w.currentIndex-1+w.audioList.length)%w.audioList.length)},getCurrentSong:function(){return w.audioList[w.currentIndex]},changePlayer:function(t,a){if(o.loadingBroadcast(!0,"加载中"),w.searchMode=!1,w.isUsrPlay=0===t,0===t){for(var i=!0,r=k.slice(0).sort(function(e,t){return e.songId-t.songId}),s=B.slice(0).sort(function(e,t){return e-t}),c=0;c<s.length;c++)r[c]&&s[c]===r[c].songId||(i=!1);if(i)return w.isUsrPlay=!0,w.audioList=k,n.$broadcast("mode.update"),void o.loadingBroadcast();o.loadingBroadcast(!0,"自定义播放列表"),e.get(SERVERURL+"/getsongsbyids?data="+encodeURIComponent(JSON.stringify({ids:B}))).success(function(e){f(e,!0),w.isUsrPlay=!0,n.$broadcast("mode.update"),o.loadingBroadcast()}).error(function(e){o.loadingBroadcast()})}else if(1===t)o.loadingBroadcast(),L();else if(2===t){w.searchMode=!0,o.loadingBroadcast(!0,"搜索"+a+"中...");var d=m(a);if(!d)return o.toastBroadcast(!0,"请输入内容",3e3),void o.loadingBroadcast();d.then(function(t){w.isUsrPlay=!1;var a=t.data.song;a=a.map(function(e){return e.songid}),e.get(SERVERURL+"/getsongsbyids?data="+encodeURIComponent(JSON.stringify({ids:a}))).success(function(e){f(e),n.$broadcast("search.update"),o.loadingBroadcast()}).error(function(e){o.loadingBroadcast()})})}else 3===t&&(o.loadingBroadcast(),w.audioList=k,w.isUsrPlay=!0,n.$broadcast("searchback.update"))},searchSong:m,addOneSong:function(e,t){for(var n=w.audioList[e],a=-1,r=0;r<k.length;r++)if(k[r].songId===n.songId){a=r;break}-1===a?(B.push(n.songId),k.push(n),w.currentIndex=k.length-1,o.toastBroadcast(!0,"添加成功~",3e3)):(t&&(w.currentIndex=a),o.toastBroadcast(!0,"已经存在~",3e3)),t||(w.audioList=k),i()},removeSong:M,getSetting:function(e){return w.hasOwnProperty(e)?w[e]:""},setSetting:function(e,t){w.hasOwnProperty(e)&&(w[e]=t)},setAudiocurrentTime:function(e){try{x.currentTime=e*x.duration}catch(t){x.setAudiocurrentTime&&x.setAudiocurrentTime(e-10>0?e-10:0)}},clearProgress:I,changeLrcTime:p,getSongs:r,upload:s}}]),mainModule.service("MessageService",["$rootScope",function(e){var t=null,n=!1,o="",a=!1,i="";return{loadingBroadcast:function(e,t){this.setLoading(e||!1),this.setLoadingMsg(t||""),this.broadcast()},setLoading:function(e){n=e},getLoading:function(){return n},setLoadingMsg:function(e){o=e},getLoadingMsg:function(){return o},toastBroadcast:function(e,n,o){if(this.settoast(e||!1),this.settoastMsg(n||""),this.broadcast(),parseInt(o)){var a=this;clearTimeout(t),t=setTimeout(function(){a.toastBroadcast(!1)},parseInt(o))}},settoast:function(e){a=e},gettoast:function(){return a},settoastMsg:function(e){i=e},gettoastMsg:function(){return i},broadcast:function(){e.$broadcast("message.update")},channelChange:function(){e.$broadcast("channel.toggle")}}}]),mainModule.controller("channelCtrl",["$rootScope","$scope","MusicService","MessageService",function(e,t,n,o){function a(){t.channels=n.getSetting("channelList"),t.showhide=i?"eleDownIn":"eleDownOut",i=!i}t.isLoading=!0,t.isUsrPlay=n.getSetting("isUsrPlay"),t.toggleChannel=a,t.$on("channel.toggle",a);var i=!1;t.togglePlayer=function(){var e=n.getSetting("isUsrPlay");t.isUsrPlay=!e,i=!1,t.showhide="eleDownOut",e?(o.loadingBroadcast(!0,"切换到随心听..."),n.changePlayer(1)):(o.loadingBroadcast(!0,"切换到用户列表..."),n.changePlayer(0))},t.upload=function(){n.upload(!0)}}]),mainModule.controller("listCtrl",["$rootScope","$scope","$state","MusicService","MessageService",function(e,t,n,o,a){function i(){localStorage.removeItem("token"),n.go("login")}function r(e){t.songs=o.getAudioList(),a.loadingBroadcast(),o.playSong(e),t.songs.length&&a.toastBroadcast(!0,t.songs[e].songName,2e3)}if(!localStorage.getItem("token"))return n.go("login"),void a.toastBroadcast(!0,"请重新登录~",3e3);t.songs=[],t.search={},e.$on("clear",function(){t.songs=[],t.$apply()}),e.$on("aduioList.update",function(){t.isUsrPlay=!1,t.isadd=!0,r(0)}),e.$on("mode.update",function(){var n=o.getSetting("isUsrPlay");e.name=n?"播放列表":"随心听",t.isUsrPlay=n,t.issearch=!1,t.isadd=!n;var a=o.getSetting("currentIndex");(a>o.getAudioList().length||-1>=a)&&(a=0),r(a)}),e.$on("searchback.update",function(){var n=o.getSetting("isUsrPlay");e.name=n?"播放列表":"随心听",t.isUsrPlay=n,t.issearch=!1,t.isadd=!1,t.songs=o.getAudioList()}),e.$on("search.update",function(){t.isUsrPlay=!1,t.issearch=!0,e.name="搜索 "+t.search.name+" 的结果",t.songs=o.getAudioList()}),t.backUsr=function(){o.changePlayer(3)},t.searchSong=function(){o.changePlayer(2,t.search.name)},t.isUsrPlay=o.getSetting("isUsrPlay");var s=navigator.userAgent;return/AppleWebKit\/(\S+)/.test(s)?void o.getSongs().then(function(){o.changePlayer(t.isUsrPlay?0:1)})["catch"](function(){a.toastBroadcast(!0,"请重新登录~~",3e3),i()}):void(e.name="本网页只支持chrome内核浏览器\n\r原因:在不使用flash下\r\n只有chrome支持播放mp3")}]),mainModule.controller("musciCtrl",["$rootScope","$scope","MusicService",function(e,t,n){t.song={songPicRadio:"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"},t.playMode=n.getSetting("playMode"),t.isPlaying=n.getSetting("isplaying"),t.changePlaying=function(){n.playorpauseSong(t.isPlaying),t.isPlaying=n.getSetting("isplaying")},e.$on("current.update",function(){e.time=null;var o=n.getCurrentSong();t.isPlaying=n.getSetting("isplaying"),t.song=o,o.songPicRadio="http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png";var a=n.getSongInfo(o.songId);a.then(function(e){var n=e.data.songList;if(n&&n.length){var o=n[0],a=o.songPicRadio;o.songPicRadio=a?/http:\/\/qukufile2\.qianqian\.com/.test(a)?a.match(/http:\/\/qukufile2\.qianqian\.com.*?jpg/)[0]:SERVERURL+"/serverget?url="+encodeURIComponent(o.songPicRadio):"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png",t.song.songPicRadio=o.songPicRadio}},function(e){t.song.songPicRadio="http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"})}),e.$on("clear",function(){e.time=null,e.alltime=null,t.song={songPicRadio:"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"},t.playMode=n.getSetting("playMode"),t.isPlaying=!1,e.$apply(),t.$apply(),n.clearProgress(),n.setSetting("isplaying",!1)}),t.prev=function(){n.playPrevSong()},t.next=function(){n.playNextSong()},t.changeLoop=function(){n.setSetting("playMode",(parseInt(t.playMode)+1)%3),t.playMode=n.getSetting("playMode")},t.changeLrc=function(e){n.changeLrcTime(e)}}]),mainModule.controller("messageCtrl",["$rootScope","$scope","MessageService",function(e,t,n){t.$on("message.update",function(){t.isLoading=n.getLoading(),t.loadingMsg=n.getLoadingMsg(),t.isToast=n.gettoast(),t.toastMsg=n.gettoastMsg()})}]),mainModule.controller("loginCtrl",["$scope","$http","$state","MessageService",function(e,t,n,o){function a(){o.loadingBroadcast(!0,"注册中"),t({url:LOGINURL+"/",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:"username="+e.username+"&password="+e.password}).success(function(e){o.loadingBroadcast(!1),-1===e.errCode?o.toastBroadcast(!0,e.data||"注册失败~~",3e3):(localStorage.setItem("token",e.data.token),n.go("index"))}).error(function(e){o.loadingBroadcast(!1),o.toastBroadcast(!0,"注册失败,请检查网络~~",3e3)})}function i(){o.loadingBroadcast(!0,"登陆中"),t({url:LOGINURL+"/auth",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:"username="+e.username+"&password="+e.password}).success(function(e){o.loadingBroadcast(!1),-1===e.errCode?o.toastBroadcast(!0,e.data||"登录失败~~",3e3):(localStorage.setItem("token",e.data.token),n.go("index"))}).error(function(e){o.loadingBroadcast(!1),o.toastBroadcast(!0,"登录失败,请检查网络~~",3e3)})}localStorage.getItem("token")&&n.go("index"),e.login=i,e.regist=a,e.username="shang"}]),shangLrcLoad=function(){function e(e,t){function n(e,t){p.push({time:e,lrcstr:t})}function o(){e.currentTime>=g-f/10&&(a(),o())}function a(){if(l++,"undefined"!=typeof p[l]){clearInterval(h),g=p[l].time,m[l-2].className="",m[l-1].className="current";var e=m[l-1].moveHeight-m[0].moveHeight-y;e=e>0?parseInt(e):0;var t=v,n=t.scrollTop;h=setInterval(function(){var o=-8,a=(e-n)/-o;a=a>0?Math.ceil(a):Math.floor(a);var i=n+a;t.scrollTop=i,e===i&&clearInterval(h),n=i},30)}}function i(){n(0,""),n(0,""),n(999999,""),p.sort(function(e,t){return e.time-t.time});var e=document.createElement("div");v.appendChild(e);for(var t=0;t<p.length;t++){var o=document.createElement("p");m.push(o),o.innerHTML=p[t].lrcstr,e.appendChild(o),o.moveHeight=o.offsetTop}}function r(e){if(e)for(var t=e.split("\n"),o=0;o<t.length;o++)for(var a=t[o].split("]"),i=0;i<a.length-1;i++){var r=a[i].match(/(\d+)\:(\d+)((\.|\:)(\d+))?/);r&&!/^\s*$/.test(a[a.length-1])&&n(60*(+r[1]||0)+(+r[2]||0)+(+r[4]||0)/100,a[a.length-1])}}function s(){for(var e=0;e<m.length;e++)m[e].className=""}function c(e){f=e}function d(){return f}function u(e,t){v.innerHTML="",l=1,g=-1,p=[],m=[],r(e),i(),c(t||0)}e="string"==typeof e?document.getElementById(e):e,t="string"==typeof t?document.getElementById(t):t;var l=1,g=-1,p=[],f=0,m=[],h=null,v=document.createElement("div"),y=t.getBoundingClientRect().height/2-50;e.addEventListener("seeked",function(){l=1,g=-1}),e.addEventListener("timeupdate",function(){o()}),v.id="shang_lrc_div",t.appendChild(v);var L=document.createElement("style");return L.type="text/css",L.innerHTML="#shang_lrc_div{margin:0;padding:0;overflow-y:scroll;overflow-x:hidden;height:100%}#shang_lrc_div::-webkit-scrollbar{width:5px;height:5px;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-button{display:none}#shang_lrc_div::-webkit-scrollbar-thumb{background:#ccc;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-corner{display:none}.current{color:blueviolet;font-weight:bold}",document.getElementsByTagName("head")[0].appendChild(L),{init:i,parseLrc:r,clearClass:s,setRepaireTimeNu:c,getRepaireTimeNu:d,loadNewLrc:u}}var t=null;return{getInstance:function(n,o){return t||(t=e(n,o)),t}}}();