function shangLrcLoad(n,e){var t={};t.currentNu=1,t.nextUpdateTime=-1,t.lrc=[],t.audioObj="string"==typeof n?document.getElementById(n):n,t.lrcObj="string"==typeof e?document.getElementById(e):e,t.lrchtmlarr=[],t.divContent=document.createElement("div"),t.repaireTimeNu=0;var o=null;return t.addLrc=function(n,e){t.lrc.push({time:n,lrcstr:e})},t.parseLrc=function(n){for(var e=n.split("\n"),o=0;o<e.length;o++)for(var i=e[o].split("]"),a=0;a<i.length-1;a++){var r=i[a].match(/(\d+)\:(\d+)((\.|\:)(\d+))?/);r&&!/^\s*$/.test(i[i.length-1])&&t.addLrc(60*(+r[1]||0)+(+r[2]||0)+(+r[4]||0)/100,i[i.length-1])}},t.checkUpdate=function(){t.audioObj.currentTime>=t.nextUpdateTime-t.repaireTimeNu/10&&(t.scrollLrc(),t.checkUpdate())},t.clearClass=function(){for(var n=0;n<t.lrchtmlarr.length;n++)t.lrchtmlarr[n].className=""},t.scrollLrc=function(){if(t.currentNu++,"undefined"!=typeof t.lrc[t.currentNu]){clearInterval(o),t.nextUpdateTime=t.lrc[t.currentNu].time,t.lrchtmlarr[t.currentNu-2].className="",t.lrchtmlarr[t.currentNu-1].className="current";var n=t.lrchtmlarr[t.currentNu-1].moveHeight-300;n=n>0?parseInt(n):0;var e=t.divContent,i=e.scrollTop;o=setInterval(function(){var t=-8,a=(n-i)/-t;a=a>0?Math.ceil(a):Math.floor(a);var r=i+a;e.scrollTop=r,n===r&&clearInterval(o),i=r},30)}},t.init=function(){if(t.addLrc(0,""),t.addLrc(0,""),t.addLrc(999999,""),t.lrc.sort(function(n,e){return n.time-e.time}),t.audioObj.addEventListener("seeked",function(){t.currentNu=1,t.nextUpdateTime=-1}),t.audioObj.addEventListener("timeupdate",function(){t.checkUpdate()}),!window.is_shang_lrc_css){var n=document.createElement("style");n.type="text/css",n.innerHTML="#shang_lrc_div{margin:0;padding:0;overflow-y:scroll;overflow-x:hidden;height:100%}#shang_lrc_div::-webkit-scrollbar{width:5px;height:5px;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-button{display:none}#shang_lrc_div::-webkit-scrollbar-track{background:#333}#shang_lrc_div::-webkit-scrollbar-thumb{background:#191919;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-corner{display:none}.current{color:blueviolet;font-weight:bold}",document.getElementsByTagName("head")[0].appendChild(n),window.is_shang_lrc_css=!0}t.divContent.id="shang_lrc_div",t.lrcObj.innerHTML="",t.lrcObj.appendChild(t.divContent);var e=document.createElement("div");t.divContent.appendChild(e);for(var o=0;o<t.lrc.length;o++){var i=document.createElement("p");t.lrchtmlarr.push(i),i.innerHTML=t.lrc[o].lrcstr,e.appendChild(i),i.moveHeight=i.offsetTop}},t}var musicApp=angular.module("MusicApp",["ui.router","MainModule"]);musicApp.config(["$stateProvider","$urlRouterProvider",function(n,e){e.otherwise("/index"),n.state("index",{url:"/index",views:{"":{templateUrl:"tpls/main.html"},"choose@index":{templateUrl:"tpls/choose.html"},"list@index":{templateUrl:"tpls/list.html"},"music@index":{templateUrl:"tpls/musicctrl.html"}}})}]);var mainModule=angular.module("MainModule",[]),SERVERURL="http://cors.coding.io";mainModule.directive("loadchannel",["$rootScope","MusicService","MessageService",function(n,e,t){return{restrict:"AE",link:function(o,i){i.on("click",function(o){o.stopPropagation();var a=i.attr("data-id");n.name="随心听: "+i.attr("data-name"),n.$apply(),e.updateList(a),t.channelChange(),t.loadingBroadcast(!0,"加载中...")})}}}]),mainModule.directive("pauseaudio",["MusicService",function(n){return{restrict:"A",link:function(e,t){t.on("click",function(e){e.stopPropagation(),n.playorpauseSong()})}}}]),mainModule.directive("removespan",["MusicService",function(n){return{restrict:"E",template:'<span class="badge"><i class="fa fa-remove"></i></span>',replace:!0,link:function(e,t){t.on("click",function(e){e.stopPropagation();var o=t.parent().attr("data-index");n.removeSong(o)})}}}]),mainModule.directive("playaudio",["MusicService",function(n){return{restrict:"AE",link:function(e,t){t.on("click",function(e){e.stopPropagation();var o=t.attr("data-index");n.getSetting("searchMode")?(n.addOneSong(o),n.changePlayer(0)):n.playSong(o)})}}}]),mainModule.service("MusicService",["$http","$q","$rootScope","MessageService",function(n,e,t,o){function i(n,e){for(var t in n)e.hasOwnProperty(t)&&(n[t]=e[t])}function a(){localStorage.setItem("shang_music",JSON.stringify({setting:P,userSongIds:b}))}function r(){s((P.currentIndex+1)%P.audioList.length)}function s(n){if(n||0===n)P.currentIndex=parseInt(n);else if(-1===P.currentIndex||P.currentIndex>=P.audioList.length)return;c(),a()}function c(){y.src=null,y.load(),y.src=P.audioList[P.currentIndex].songLink,y.play(),P.isplaying=!0,t.$broadcast("current.update"),o.toastBroadcast(!0,P.audioList[P.currentIndex].songName,2e3),S=shangLrcLoad(y,"lrcdiv"),n.get(SERVERURL+"?method=get&callback=obj&url=http://music.baidu.com"+P.audioList[P.currentIndex].lrcLink).success(function(n){S.parseLrc(n.data),S.repaireTimeNu=0,S.init()}).error(function(){S.parseLrc("[00:00]未找到(┬＿┬)"),S.repaireTimeNu=0,S.init()})}function u(){var n=y.currentTime,e=Math.floor(n/60),t=Math.round(n%60)<10?"0"+Math.round(n%60):Math.round(n%60);return e+":"+t}function d(n){S&&y&&(S.repaireTimeNu=parseInt(S.repaireTimeNu)+parseInt(n),o.toastBroadcast(!0,S.repaireTimeNu/10+"",3e3))}function l(n){if(!n||!n.data||!n.data.songList)return void(P.audioList=[]);var e=n.data.songList;P.audioList=e.filter(function(n){return n.songLink&&/file\.qianqian\.com/.test(n.songLink)&&!/serverget\?url/.test(n.songLink)?n.songLink="serverget?url="+encodeURIComponent(n.songLink):n.songLink&&(n.songLink=n.songLink.replace("http://yinyueshiting.baidu.com/data2/music/","http://musicdata.baidu.com/data2/music/")),n.rate})}function g(t){if(t=t.trim()){var i=e.defer();return n.get(SERVERURL+"?method=get&url="+encodeURIComponent("http://sug.music.baidu.com/info/suggestion?format=json&word="+t+"&version=2&from=0")).success(function(n){i.resolve(n)}).error(function(n){i.resolve("")}),i.promise}o.toastBroadcast(!0,"请输入内容",3e3)}function p(){var t=e.defer();return n.get("getchannellist").success(function(n){t.resolve(n.channel_list)}).error(function(n){t.reject(n)}),t.promise}function h(t){var o=e.defer();return n.get("getsonglink?id="+t).success(function(n){o.resolve(n)}).error(function(n){o.reject(n)}),o.promise}function f(n){var e=h(n);e.then(function(n){l(n),t.$broadcast("aduioList.update")},function(n){P.audioList=[],t.$broadcast("aduioList.update")})}function m(){var n=p();n.then(function(n){P.channelList=n;var e=Math.floor(Math.random()*n.length);f(e),o.channelChange(),o.loadingBroadcast(!0,n[e].channel_name),t.name=n[e].channel_name},function(n){})}var v,L=null,y=new Audio,S=null,b=[5963228],M=[],P={currentHadPlayedNu:0,audioList:[],currentIndex:-1,isOneLoop:!1,isUsrPlay:!0,isplaying:!1,channelList:[],searchMode:!1},k=localStorage.shang_music;if(k)try{var x=JSON.parse(k);v=x.setting||{},b=x.userSongIds||[]}catch(I){v={},b=[]}finally{i(P,v)}return y.onerror=function(){P.currentHadPlayedNu<=2?setTimeout(function(){y.src=P.audioList[P.currentIndex].songLink,y.play(),P.currentHadPlayedNu++},500):(clearTimeout(L),L=setTimeout(function(){P.currentHadPlayedNu=0,o.toastBroadcast(!0,"加载失败,播放下一首(┬＿┬)",1e3),r()},1e3))},y.ontimeupdate=function(){t.time=u(),t.$apply()},y.onended=function(){P.isOneLoop?s(P.currentIndex):r()},t.$on("clear",function(){S=shangLrcLoad(y,"lrcdiv"),S.parseLrc(""),S.repaireTimeNu=0,S.init(),y.src=null,y.load()}),{channelList:p,songlink:h,getSongInfo:function(t){var o=e.defer();return n.get("getsonginfo?id="+t).success(function(n){o.resolve(n)}).error(function(n){o.reject(n)}),o.promise},updateList:f,getAudioList:function(){return P.audioList},playSong:s,playorpauseSong:function(n){n?(y.pause(),P.isplaying=!1):(y.play(),P.isplaying=!0)},playNextSong:r,playPrevSong:function(){this.playSong((P.currentIndex-1+P.audioList.length)%P.audioList.length)},getCurrentSong:function(){return P.audioList[P.currentIndex]},changePlayer:function(e,i){if(o.loadingBroadcast(!0,"加载中"),P.searchMode=!1,P.isUsrPlay=0===e,0===e){for(var a=!1,r=0;r<b.length;r++){a=!1;for(var s=0,c=P.audioList;s<c.length;s++)if(b[r]===c[s].songId){a=!0;break}if(!a)break}if(P.audioList.length||(a=!1),a)return P.isUsrPlay=!0,t.$broadcast("mode.update"),void o.loadingBroadcast();o.loadingBroadcast(!0,"自定义播放列表"),n.get("getsongsbyids?data="+encodeURIComponent(JSON.stringify({ids:b}))).success(function(n){l(n),P.isUsrPlay=!0,t.$broadcast("mode.update"),o.loadingBroadcast()}).error(function(n){o.loadingBroadcast()})}else if(1===e)o.loadingBroadcast(),m();else if(2===e){P.searchMode=!0,o.loadingBroadcast(!0,"搜索"+i+"中...");var u=g(i);u.then(function(e){P.isUsrPlay=!0,M=P.audioList;var i=e.data.song;i=i.map(function(n){return n.songid}),n.get("getsongsbyids?data="+encodeURIComponent(JSON.stringify({ids:i}))).success(function(n){l(n),t.$broadcast("search.update"),o.loadingBroadcast()}).error(function(n){o.loadingBroadcast()})})}else 3===e&&(o.loadingBroadcast(),P.audioList=M,P.isUsrPlay=!0,t.$broadcast("searchback.update"))},searchSong:g,addOneSong:function(n){b.push(P.audioList[n].songId),M.push(P.audioList[n]),P.audioList=M,P.currentIndex=M.length-1,a()},removeSong:function(n){var e=parseInt(n);return 1===P.audioList.length?(P.audioList=[],b=[],P.currentIndex=-1,t.$broadcast("searchback.update"),void t.$broadcast("clear")):(e===P.currentIndex&&r(),P.audioList.splice(e,1),b.splice(e,1),e<=P.currentIndex&&(P.currentIndex-=1),t.$broadcast("searchback.update"),void a())},getSetting:function(n){return P.hasOwnProperty(n)?P[n]:""},setSetting:function(n,e){P.hasOwnProperty(n)&&(P[n]=e)},changeLrcTime:d}}]),mainModule.service("MessageService",["$rootScope",function(n){var e=null,t=!1,o="",i=!1,a="";return{loadingBroadcast:function(n,e){this.setLoading(n||!1),this.setLoadingMsg(e||""),this.broadcast()},setLoading:function(n){t=n},getLoading:function(){return t},setLoadingMsg:function(n){o=n},getLoadingMsg:function(){return o},toastBroadcast:function(n,t,o){if(this.settoast(n||!1),this.settoastMsg(t||""),this.broadcast(),parseInt(o)){var i=this;clearTimeout(e),e=setTimeout(function(){i.toastBroadcast(!1)},parseInt(o))}},settoast:function(n){i=n},gettoast:function(){return i},settoastMsg:function(n){a=n},gettoastMsg:function(){return a},broadcast:function(){n.$broadcast("message.update")},channelChange:function(){n.$broadcast("channel.toggle")}}}]),mainModule.controller("channelCtrl",["$rootScope","$scope","MusicService","MessageService",function(n,e,t,o){function i(){e.channels=t.getSetting("channelList"),e.showhide=a?"eleDownIn":"eleDownOut",a=!a}e.isLoading=!0,e.toggleChannel=i,e.$on("channel.toggle",i);var a=!1;e.togglePlayer=function(){var n=t.getSetting("isUsrPlay");e.isUsrPlay=n,a=!1,e.showhide="eleDownOut",t.changePlayer(n?1:0)}}]),mainModule.controller("listCtrl",["$rootScope","$scope","MusicService","MessageService",function(n,e,t,o){function i(n){e.songs=t.getAudioList(),o.loadingBroadcast(),t.playSong(n),o.toastBroadcast(!0,e.songs[n].songName,2e3)}e.songs=[],e.search={},n.$on("aduioList.update",function(){e.isUsrPlay=!1,i(0)}),n.$on("mode.update",function(){var o=t.getSetting("isUsrPlay");n.name=o?"播放列表":"随心听",e.isUsrPlay=o,e.issearch=!1;var a=t.getSetting("currentIndex");(a>t.getAudioList().length||-1>=a)&&(a=0),i(a)}),n.$on("searchback.update",function(){var o=t.getSetting("isUsrPlay");n.name=o?"播放列表":"随心听",e.isUsrPlay=o,e.issearch=!1,e.songs=t.getAudioList()}),n.$on("search.update",function(){e.issearch=!0,n.name="搜索 "+e.search.name+" 的结果",e.songs=t.getAudioList()}),e.backUsr=function(){t.changePlayer(3)},e.searchSong=function(){t.changePlayer(2,e.search.name)},e.isUsrPlay=t.getSetting("isUsrPlay"),t.changePlayer(e.isUsrPlay?0:1)}]),mainModule.controller("musciCtrl",["$rootScope","$scope","MusicService",function(n,e,t){e.song={songPicRadio:"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"},e.isoneloop=t.getSetting("isOneLoop"),e.isPlaying=t.getSetting("isplaying"),e.changePlaying=function(){t.playorpauseSong(e.isPlaying),e.isPlaying=t.getSetting("isplaying")},n.$on("current.update",function(){var n=t.getCurrentSong();e.isPlaying=t.getSetting("isplaying"),e.song=n,n.songPicRadio="http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png";var o=t.getSongInfo(n.songId);o.then(function(n){var t=n.data.songList;if(t&&t.length){var o=t[0],i=o.songPicRadio;o.songPicRadio=i?/http:\/\/qukufile2\.qianqian\.com/.test(i)?i.match(/http:\/\/qukufile2\.qianqian\.com.*?jpg/)[0]:"serverget?url="+encodeURIComponent(o.songPicRadio):"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png",e.song.songPicRadio=o.songPicRadio}},function(n){e.song.songPicRadio="http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"})}),n.$on("clear",function(){n.time=null,e.song={songPicRadio:"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"},e.isoneloop=t.getSetting("isOneLoop"),e.isPlaying=!1,t.setSetting("isplaying",!1),n.$apply()}),e.prev=function(){t.playPrevSong()},e.next=function(){t.playNextSong()},e.changeLoop=function(){t.setSetting("isOneLoop",!e.isoneloop),e.isoneloop=t.getSetting("isOneLoop")},e.changeLrc=function(n){t.changeLrcTime(n)}}]),mainModule.controller("messageCtrl",["$rootScope","$scope","MessageService",function(n,e,t){e.$on("message.update",function(){e.isLoading=t.getLoading(),e.loadingMsg=t.getLoadingMsg(),e.isToast=t.gettoast(),e.toastMsg=t.gettoastMsg()})}]);