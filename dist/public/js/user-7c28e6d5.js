function shangLrcLoad(e,t){var n={};n.currentNu=1,n.nextUpdateTime=-1,n.lrc=[],n.audioObj="string"==typeof e?document.getElementById(e):e,n.lrcObj="string"==typeof t?document.getElementById(t):t,n.lrchtmlarr=[],n.divContent=document.createElement("div"),n.repaireTimeNu=0;var i=null;return n.addLrc=function(e,t){n.lrc.push({time:e,lrcstr:t})},n.parseLrc=function(e){for(var t=e.split("\n"),i=0;i<t.length;i++)for(var o=t[i].split("]"),r=0;r<o.length-1;r++){var a=o[r].match(/(\d+)\:(\d+)((\.|\:)(\d+))?/);a&&!/^\s*$/.test(o[o.length-1])&&n.addLrc(60*(+a[1]||0)+(+a[2]||0)+(+a[4]||0)/100,o[o.length-1])}},n.checkUpdate=function(){n.audioObj.currentTime>=n.nextUpdateTime-n.repaireTimeNu/10&&(n.scrollLrc(),n.checkUpdate())},n.clearClass=function(){for(var e=0;e<n.lrchtmlarr.length;e++)n.lrchtmlarr[e].className=""},n.scrollLrc=function(){if(n.currentNu++,"undefined"!=typeof n.lrc[n.currentNu]){clearInterval(i),n.nextUpdateTime=n.lrc[n.currentNu].time,n.lrchtmlarr[n.currentNu-2].className="",n.lrchtmlarr[n.currentNu-1].className="current";var e=n.lrchtmlarr[n.currentNu-1].moveHeight-300;e=e>0?parseInt(e):0;var t=n.divContent,o=t.scrollTop;i=setInterval(function(){var n=-8,r=(e-o)/-n;r=r>0?Math.ceil(r):Math.floor(r);var a=o+r;t.scrollTop=a,e===a&&clearInterval(i),o=a},30)}},n.init=function(){if(n.addLrc(0,""),n.addLrc(0,""),n.addLrc(999999,""),n.lrc.sort(function(e,t){return e.time-t.time}),n.audioObj.addEventListener("seeked",function(){n.currentNu=1,n.nextUpdateTime=-1}),n.audioObj.addEventListener("timeupdate",function(){n.checkUpdate()}),!window.is_shang_lrc_css){var e=document.createElement("style");e.type="text/css",e.innerHTML="#shang_lrc_div{margin:0;padding:0;overflow-y:scroll;overflow-x:hidden;height:100%}#shang_lrc_div::-webkit-scrollbar{width:5px;height:5px;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-button{display:none}#shang_lrc_div::-webkit-scrollbar-thumb{background:#ccc;border-radius:4px}#shang_lrc_div::-webkit-scrollbar-corner{display:none}.current{color:blueviolet;font-weight:bold}",document.getElementsByTagName("head")[0].appendChild(e),window.is_shang_lrc_css=!0}n.divContent.id="shang_lrc_div",n.lrcObj.innerHTML="",n.lrcObj.appendChild(n.divContent);var t=document.createElement("div");n.divContent.appendChild(t);for(var i=0;i<n.lrc.length;i++){var o=document.createElement("p");n.lrchtmlarr.push(o),o.innerHTML=n.lrc[i].lrcstr,t.appendChild(o),o.moveHeight=o.offsetTop}},n}var musicApp=angular.module("MusicApp",["ui.router","MainModule"]);musicApp.config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/index"),e.state("index",{url:"/index",views:{"":{templateUrl:"tpls/main.html"},"choose@index":{templateUrl:"tpls/choose.html"},"list@index":{templateUrl:"tpls/list.html"},"music@index":{templateUrl:"tpls/musicctrl.html"}}})}]);var mainModule=angular.module("MainModule",[]),SERVERURL="http://cors.coding.io";mainModule.directive("loadchannel",["$rootScope","MusicService","MessageService",function(e,t,n){return{restrict:"AE",link:function(i,o){o.on("click",function(i){i.stopPropagation();var r=o.attr("data-id");e.name="随心听: "+o.attr("data-name"),e.$apply(),t.updateList(r),n.channelChange(),n.loadingBroadcast(!0,"加载中...")})}}}]),mainModule.directive("pauseaudio",["MusicService",function(e){return{restrict:"A",link:function(t,n){n.on("click",function(t){t.stopPropagation(),e.playorpauseSong()})}}}]),mainModule.directive("removespan",["MusicService",function(e){return{restrict:"E",template:'<span class="badge"><i class="fa fa-remove"></i></span>',replace:!0,link:function(t,n){n.on("click",function(t){t.stopPropagation();var i=n.parent().attr("data-index");e.removeSong(i)})}}}]),mainModule.directive("playaudio",["MusicService",function(e){return{restrict:"AE",link:function(t,n){n.on("click",function(t){t.stopPropagation();var i=n.attr("data-index");e.getSetting("searchMode")?(e.addOneSong(i),e.changePlayer(0)):e.playSong(i)})}}}]),mainModule.directive("detectiveenter",["MusicService",function(e){return{restrict:"AE",link:function(t,n){n.on("keydown",function(t){13===t.keyCode&&e.changePlayer(2,n[0].value)})}}}]),mainModule.directive("progressdiv",["MusicService",function(e){return{restrict:"AE",link:function(t,n){function i(t){if(o){var i=n[0].getBoundingClientRect(),c=a.getBoundingClientRect().width,s=t.x-i.left;s>c?s=c:s>i.width&&(s=i.width),r.style.width=s+"px",e.setAudiocurrentTime(s/i.width)}return t.stopPropagation(),t.preventDefault(),!1}var o=!1,r=document.getElementById("currentprogress"),a=document.getElementById("loadedprogress");n.on("mousedown",function(){o=!0,document.addEventListener("mousemove",i)}),document.addEventListener("mouseup",function(e){i(e),o=!1,document.removeEventListener("mousemove",i)})}}}]),mainModule.service("MusicService",["$http","$q","$rootScope","MessageService",function(e,t,n,i){function o(e,t){for(var n in e)t.hasOwnProperty(n)&&(e[n]=t[n])}function r(){var e={};for(var t in k)k.hasOwnProperty(t)&&"audioList"!=t&&"channelList"!=t&&(e[t]=k[t]);setTimeout(function(){localStorage.setItem("shang_music",JSON.stringify({setting:e,userSongIds:P}))})}function a(){B?(B.style.width=y()*N+"px",w.style.width=M.currentTime/M.duration*N+"px"):(B=document.getElementById("loadedprogress"),T=document.getElementById("progressbar"),w=document.getElementById("currentprogress"),N=T.getBoundingClientRect().width||0)}function c(){s((k.currentIndex+1)%k.audioList.length)}function s(e){if(e||0===e)k.currentIndex=parseInt(e);else if(-1===k.currentIndex||k.currentIndex>=k.audioList.length)return;u(),r()}function u(){M.src=null,M.load(),M.src=k.audioList[k.currentIndex].songLink,M.play(),k.isplaying=!0,n.alltime=d(k.audioList[k.currentIndex].time),n.$broadcast("current.update"),i.toastBroadcast(!0,k.audioList[k.currentIndex].songName,2e3),b=shangLrcLoad(M,"lrcdiv"),e.get(SERVERURL+"?method=get&callback=obj&url=http://music.baidu.com"+k.audioList[k.currentIndex].lrcLink).success(function(e){b.parseLrc(e.data),b.repaireTimeNu=0,b.init()}).error(function(){b.parseLrc("[00:00]未找到(┬＿┬)"),b.repaireTimeNu=0,b.init()})}function d(e){e=e||M.currentTime;var t=Math.floor(e/60),n=Math.round(e%60)<10?"0"+Math.round(e%60):Math.round(e%60);return t+":"+n}function l(e){b&&M&&(b.repaireTimeNu=parseInt(b.repaireTimeNu)+parseInt(e),i.toastBroadcast(!0,b.repaireTimeNu/10+"",3e3))}function g(e){if(!e||!e.data||!e.data.songList)return void(k.audioList=[]);var t=e.data.songList;k.audioList=t.filter(function(e){return e.songLink&&/file\.qianqian\.com/.test(e.songLink)&&!/serverget\?url/.test(e.songLink)?e.songLink="serverget?url="+encodeURIComponent(e.songLink):e.songLink&&(e.songLink=e.songLink.replace("http://yinyueshiting.baidu.com/data2/music/","http://musicdata.baidu.com/data2/music/")),e.rate})}function p(n){if(n=n.trim()){var o=t.defer();return e.get(SERVERURL+"?method=get&url="+encodeURIComponent("http://sug.music.baidu.com/info/suggestion?format=json&word="+n+"&version=2&from=0")).success(function(e){o.resolve(e)}).error(function(e){o.resolve("")}),o.promise}i.toastBroadcast(!0,"请输入内容",3e3)}function m(){var n=t.defer();return e.get("getchannellist").success(function(e){n.resolve(e.channel_list)}).error(function(e){n.reject(e)}),n.promise}function h(n){var i=t.defer();return e.get("getsonglink?id="+n).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise}function f(e){var t=h(e);t.then(function(e){g(e),n.$broadcast("aduioList.update")},function(e){k.audioList=[],n.$broadcast("aduioList.update")})}function v(){var e=m();e.then(function(e){k.channelList=e;var t=Math.floor(Math.random()*e.length);f(t),i.channelChange(),i.loadingBroadcast(!0,e[t].channel_name),n.name=e[t].channel_name},function(e){})}function y(){if(!M)return 0;var e=M.buffered;if(e.length){var t=e.end(e.length-1);return t/M.duration}}var L,S=null,M=new Audio,b=null,P=[5963228],I=[],k={currentHadPlayedNu:0,audioList:[],currentIndex:-1,playMode:0,isUsrPlay:!0,isplaying:!1,channelList:[],searchMode:!1},x=localStorage.getItem("shang_music");if(x)try{var $=JSON.parse(x);L=$.setting||{},P=$.userSongIds||[]}catch(U){L={},P=[]}finally{o(k,L)}M.onerror=function(){k.currentHadPlayedNu<=2?setTimeout(function(){M.src=k.audioList[k.currentIndex].songLink,M.play(),k.currentHadPlayedNu++},500):(clearTimeout(S),S=setTimeout(function(){k.currentHadPlayedNu=0,i.toastBroadcast(!0,"加载失败,播放下一首(┬＿┬)",1e3),c()},1e3))},M.ontimeupdate=function(){n.time=d(),n.$apply(),a()},M.onended=function(){if(1===k.playMode)s(k.currentIndex);else if(0===k.playMode)c();else{var e=k.audioList.length;s(Math.floor(Math.random()*e))}};var B=document.getElementById("loadedprogress"),T=document.getElementById("progressbar"),w=document.getElementById("currentprogress"),N=0;return n.$on("clear",function(){b=shangLrcLoad(M,"lrcdiv"),b.parseLrc(""),b.repaireTimeNu=0,b.init(),M.src=null,M.load()}),{channelList:m,songlink:h,getSongInfo:function(n){var i=t.defer();return e.get("getsonginfo?id="+n).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},updateList:f,getAudioList:function(){return k.audioList},playSong:s,playorpauseSong:function(e){e?(M.pause(),k.isplaying=!1):(M.play(),k.isplaying=!0)},playNextSong:c,playPrevSong:function(){this.playSong((k.currentIndex-1+k.audioList.length)%k.audioList.length)},getCurrentSong:function(){return k.audioList[k.currentIndex]},changePlayer:function(t,o){if(i.loadingBroadcast(!0,"加载中"),k.searchMode=!1,k.isUsrPlay=0===t,0===t){for(var r=!1,a=0;a<P.length;a++){r=!1;for(var c=0,s=k.audioList;c<s.length;c++)if(P[a]===s[c].songId){r=!0;break}if(!r)break}if(k.audioList.length||(r=!1),r)return k.isUsrPlay=!0,n.$broadcast("mode.update"),void i.loadingBroadcast();i.loadingBroadcast(!0,"自定义播放列表"),e.get("getsongsbyids?data="+encodeURIComponent(JSON.stringify({ids:P}))).success(function(e){g(e),k.isUsrPlay=!0,n.$broadcast("mode.update"),i.loadingBroadcast()}).error(function(e){i.loadingBroadcast()})}else if(1===t)i.loadingBroadcast(),v();else if(2===t){k.searchMode=!0,i.loadingBroadcast(!0,"搜索"+o+"中...");var u=p(o);u.then(function(t){k.isUsrPlay=!0,I=k.audioList;var o=t.data.song;o=o.map(function(e){return e.songid}),e.get("getsongsbyids?data="+encodeURIComponent(JSON.stringify({ids:o}))).success(function(e){g(e),n.$broadcast("search.update"),i.loadingBroadcast()}).error(function(e){i.loadingBroadcast()})})}else 3===t&&(i.loadingBroadcast(),k.audioList=I,k.isUsrPlay=!0,n.$broadcast("searchback.update"))},searchSong:p,addOneSong:function(e){P.push(k.audioList[e].songId),I.push(k.audioList[e]),k.audioList=I,k.currentIndex=I.length-1,r()},removeSong:function(e){var t=parseInt(e);return 1===k.audioList.length?(k.audioList=[],P=[],k.currentIndex=-1,n.$broadcast("searchback.update"),void n.$broadcast("clear")):(t===k.currentIndex&&c(),k.audioList.splice(t,1),P.splice(t,1),t<=k.currentIndex&&(k.currentIndex-=1),n.$broadcast("searchback.update"),void r())},getSetting:function(e){return k.hasOwnProperty(e)?k[e]:""},setSetting:function(e,t){k.hasOwnProperty(e)&&(k[e]=t)},setAudiocurrentTime:function(e){try{M.currentTime=e*M.duration}catch(t){M.setAudiocurrentTime&&M.setAudiocurrentTime(e-10>0?e-10:0)}},changeLrcTime:l}}]),mainModule.service("MessageService",["$rootScope",function(e){var t=null,n=!1,i="",o=!1,r="";return{loadingBroadcast:function(e,t){this.setLoading(e||!1),this.setLoadingMsg(t||""),this.broadcast()},setLoading:function(e){n=e},getLoading:function(){return n},setLoadingMsg:function(e){i=e},getLoadingMsg:function(){return i},toastBroadcast:function(e,n,i){if(this.settoast(e||!1),this.settoastMsg(n||""),this.broadcast(),parseInt(i)){var o=this;clearTimeout(t),t=setTimeout(function(){o.toastBroadcast(!1)},parseInt(i))}},settoast:function(e){o=e},gettoast:function(){return o},settoastMsg:function(e){r=e},gettoastMsg:function(){return r},broadcast:function(){e.$broadcast("message.update")},channelChange:function(){e.$broadcast("channel.toggle")}}}]),mainModule.controller("channelCtrl",["$rootScope","$scope","MusicService","MessageService",function(e,t,n,i){function o(){t.channels=n.getSetting("channelList"),t.showhide=r?"eleDownIn":"eleDownOut",r=!r}t.isLoading=!0,t.isUsrPlay=n.getSetting("isUsrPlay"),t.toggleChannel=o,t.$on("channel.toggle",o);var r=!1;t.togglePlayer=function(){var e=n.getSetting("isUsrPlay");t.isUsrPlay=!e,r=!1,t.showhide="eleDownOut",e?(i.loadingBroadcast(!0,"切换到随心听..."),n.changePlayer(1)):(i.loadingBroadcast(!0,"切换到用户列表..."),n.changePlayer(0))}}]),mainModule.controller("listCtrl",["$rootScope","$scope","MusicService","MessageService",function(e,t,n,i){function o(e){t.songs=n.getAudioList(),i.loadingBroadcast(),n.playSong(e),i.toastBroadcast(!0,t.songs[e].songName,2e3)}t.songs=[],t.search={},e.$on("aduioList.update",function(){t.isUsrPlay=!1,o(0)}),e.$on("mode.update",function(){var i=n.getSetting("isUsrPlay");e.name=i?"播放列表":"随心听",t.isUsrPlay=i,t.issearch=!1;var r=n.getSetting("currentIndex");(r>n.getAudioList().length||-1>=r)&&(r=0),o(r)}),e.$on("searchback.update",function(){var i=n.getSetting("isUsrPlay");e.name=i?"播放列表":"随心听",t.isUsrPlay=i,t.issearch=!1,t.songs=n.getAudioList()}),e.$on("search.update",function(){t.issearch=!0,e.name="搜索 "+t.search.name+" 的结果",t.songs=n.getAudioList()}),t.backUsr=function(){n.changePlayer(3)},t.searchSong=function(){n.changePlayer(2,t.search.name)},t.isUsrPlay=n.getSetting("isUsrPlay");var r=navigator.userAgent;return/AppleWebKit\/(\S+)/.test(r)?void n.changePlayer(t.isUsrPlay?0:1):void(e.name="本网页只支持chrome内核浏览器\n\r原因:在不使用flash下\r\n只有chrome支持播放mp3")}]),mainModule.controller("musciCtrl",["$rootScope","$scope","MusicService",function(e,t,n){t.song={songPicRadio:"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"},t.playMode=n.getSetting("playMode"),t.isPlaying=n.getSetting("isplaying"),t.changePlaying=function(){n.playorpauseSong(t.isPlaying),t.isPlaying=n.getSetting("isplaying")},e.$on("current.update",function(){var e=n.getCurrentSong();t.isPlaying=n.getSetting("isplaying"),t.song=e,e.songPicRadio="http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png";var i=n.getSongInfo(e.songId);i.then(function(e){var n=e.data.songList;if(n&&n.length){var i=n[0],o=i.songPicRadio;i.songPicRadio=o?/http:\/\/qukufile2\.qianqian\.com/.test(o)?o.match(/http:\/\/qukufile2\.qianqian\.com.*?jpg/)[0]:"serverget?url="+encodeURIComponent(i.songPicRadio):"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png",t.song.songPicRadio=i.songPicRadio}},function(e){t.song.songPicRadio="http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"})}),e.$on("clear",function(){e.time=null,t.song={songPicRadio:"http://7xiblm.com1.z0.glb.clouddn.com/o_19irpgates13ec7n3a1gck1hho9.png"},t.playMode=n.getSetting("playMode"),t.isPlaying=!1,n.setSetting("isplaying",!1),e.$apply()}),t.prev=function(){n.playPrevSong()},t.next=function(){n.playNextSong()},t.changeLoop=function(){n.setSetting("playMode",(parseInt(t.playMode)+1)%3),t.playMode=n.getSetting("playMode")},t.changeLrc=function(e){n.changeLrcTime(e)}}]),mainModule.controller("messageCtrl",["$rootScope","$scope","MessageService",function(e,t,n){t.$on("message.update",function(){t.isLoading=n.getLoading(),t.loadingMsg=n.getLoadingMsg(),t.isToast=n.gettoast(),t.toastMsg=n.gettoastMsg()})}]);